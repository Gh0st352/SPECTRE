<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Reference</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>S.P.E.C.T.R.E.</h1>


<ul>
  <li><a href="../manual.html">Index</a></li>
</ul>



<h2>Source</h2>
<ul class="nowrap">
  <li><a href="../source/ai.lua.html">ai.lua</a></li>
  <li><a href="../source/dynamic_spawner.lua.html">dynamic_spawner.lua</a></li>
  <li><strong>fileio.lua</strong></li>
  <li><a href="../source/object.lua.html">object.lua</a></li>
  <li><a href="../source/player_manager.lua.html">player_manager.lua</a></li>
  <li><a href="../source/point_manager.lua.html">point_manager.lua</a></li>
  <li><a href="../source/poly.lua.html">poly.lua</a></li>
  <li><a href="../source/spectre.lua.html">spectre.lua</a></li>
  <li><a href="../source/utils.lua.html">utils.lua</a></li>
  <li><a href="../source/world.lua.html">world.lua</a></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/AI.html">AI</a></li>
  <li><a href="../modules/DYNAMIC_SPAWNER.html">DYNAMIC_SPAWNER</a></li>
  <li><a href="../modules/FileIO.html">FileIO</a></li>
  <li><a href="../modules/OBJECT.html">OBJECT</a></li>
  <li><a href="../modules/PLAYER_MANAGER.html">PLAYER_MANAGER</a></li>
  <li><a href="../modules/POINT_MANAGER.html">POINT_MANAGER</a></li>
  <li><a href="../modules/POLY.html">POLY</a></li>
  <li><a href="../modules/SPECTRE.html">SPECTRE</a></li>
  <li><a href="../modules/Utils.html">Utils</a></li>
  <li><a href="../modules/WORLD.html">WORLD</a></li>
</ul>
<h2>Topics</h2>
<ul class="">
  <li><a href="../topics/readme.md.html">readme</a></li>
</ul>

</div>

<div id="content">

    <h2>fileio.lua</h2>
<pre>
<span class="comment">--- **SPECTRE.FileIO**
</span><span class="comment">--
</span><span class="comment">-- File Input/Output operations for tracking game data.
</span><span class="comment">--
</span><span class="comment">-- ===
</span><span class="comment">--      <a href="../modules/SPECTRE.html#">SPECTRE</a> ---&gt; ???
</span><span class="comment">-- ===
</span><span class="comment">--
</span><span class="comment">--  ***FileIO for SPECTRE.***
</span><span class="comment">--
</span><span class="comment">--   * The FileIO Class.
</span><span class="comment">--
</span><span class="comment">--   * All aspects of the FileIO are accessed via this class.
</span><span class="comment">--
</span><span class="comment">--     -- Send table Data from DCS -&gt; text file.
</span><span class="comment">--     -- Import table Data from text file -&gt; DCS
</span><span class="comment">--     -- Store and retrieve various aspects of SPECTRE.
</span><span class="comment">--
</span><span class="comment">-- ===
</span><span class="comment">--
</span><span class="comment">--
</span><span class="comment">-- @module FileIO
</span><span class="comment">-- @extends SPECTRE
</span>
env.info(<span class="string">" *** LOAD S.P.E.C.T.R.E. - File IO *** "</span>)

<span class="comment">---FileIO.
</span><span class="comment">-- ===
</span><span class="comment">--
</span><span class="comment">-- *File Input/Output operations for tracking game data.*
</span><span class="comment">--
</span><span class="comment">-- ===
</span><span class="comment">-- @section FileIO
</span>
<span class="comment">--- ###FileIO
</span><span class="comment">-- ===
</span><span class="comment">--
</span><span class="comment">--      File Input/Output operations for tracking game data.
</span><span class="comment">--
</span><span class="comment">-- * FileIO for SPECTRE
</span><span class="comment">--
</span><span class="comment">--   * The FileIO Class.
</span><span class="comment">--
</span><span class="comment">--   * All aspects of the FileIO are accessed via this class.
</span><span class="comment">--
</span><span class="comment">-- @field #FileIO
</span><span class="comment">-- @field ClassName SPECTRE.OBJECT.FileIO
</span><a id="49"></a><span class="comment">-- @field ClassID The ID number of the class.
</span>SPECTRE.FileIO = {
  ClassName = <span class="string">"FileIO"</span>,
  ClassID = <span class="number">0</span>,
}

<span class="comment">---FileIO functions.
</span><span class="comment">-- ===
</span><span class="comment">-- *All Functions associated with the class.*
</span><span class="comment">--
</span><span class="comment">-- ===
</span><span class="comment">-- @section FileIO functions
</span>
<span class="comment">---Access and store info from GetGroundResourceData from PlayerManagerMod.
</span><span class="comment">--
</span><span class="comment">-- REQUIRES PLAYERMANAGERMOD
</span><span class="comment">--
</span><span class="comment">-- @param GroundDataTable : GetGroundResourceData from PlayerManagerMod
</span><a id="67"></a><span class="comment">-- @return LoadedDatabase : Table of GetGroundResourceData
</span><span class="keyword">function</span> SPECTRE.FileIO.StoreGroundResourceData(GroundDataTable)
  <span class="keyword">local</span> PlayerDatabase_Path  = lfs.writedir() .. <span class="string">"PlayerDatabase/"</span>
  <span class="keyword">local</span> PlayerDatabase_File = PlayerDatabase_Path .. <span class="string">"/"</span> ..  <span class="string">"GroundResources.lua"</span>
  SPECTRE.FileIO.persistence.store(PlayerDatabase_File, GroundDataTable)
<span class="keyword">end</span>

<span class="comment">--- Checks if a specific file exists.
</span><span class="comment">--
</span><span class="comment">-- @param filePath : The filepath for the file, PATH + FILE.extension
</span><span class="comment">-- @return true : File does indeed exist
</span><a id="78"></a><span class="comment">-- @return false : File does not exist :(
</span><span class="keyword">function</span> SPECTRE.FileIO.file_exists(filePath)
  <span class="keyword">local</span> file = <span class="global">io</span>.open(filePath, <span class="string">"r"</span>)
  <span class="keyword">if</span> (file) <span class="keyword">then</span>
    <span class="global">io</span>.close(file)
    <span class="keyword">return</span> <span class="keyword">true</span>
  <span class="keyword">else</span>
    <span class="keyword">return</span> <span class="keyword">false</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">do</span>
  <span class="keyword">local</span> write, writeIndent, writers, refCount;
  <span class="comment">---FileIO.persistence.
</span>  <span class="comment">-- ===
</span>  <span class="comment">--
</span>  <span class="comment">-- *Stores persistence generation functions.*
</span>  <span class="comment">--
</span>  <span class="comment">-- ===
</span>  <span class="comment">-- @section persistence
</span>
  <span class="comment">--- ###Houses methods for interacting with files outside of the game.
</span>  <span class="comment">-- ===
</span>  <span class="comment">--
</span>  <span class="comment">--     -Exports table of data from MissionScripting environment to text file
</span>  <span class="comment">--     -Imports table of data from text file to MissionScripting environment
</span>  <span class="comment">--     -Dumps table to string format
</span>  <a id="105"></a><span class="comment">-- @field #persistence
</span>  SPECTRE.FileIO.persistence = {}

  <span class="comment">---Convert table to string to output to console.
</span>  <span class="comment">--@param o : table
</span>  <a id="110"></a><span class="comment">--@return o : String version of table
</span>  <span class="keyword">function</span> SPECTRE.FileIO.persistence.dump(o)
    <span class="keyword">if</span> <span class="global">type</span>(o) == <span class="string">'table'</span> <span class="keyword">then</span>
      <span class="keyword">local</span> s = <span class="string">'{ '</span>
      <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="global">pairs</span>(o) <span class="keyword">do</span>
        <span class="keyword">if</span> <span class="global">type</span>(k) ~= <span class="string">'number'</span> <span class="keyword">then</span> k = <span class="string">'"'</span>..k..<span class="string">'"'</span> <span class="keyword">end</span>
        s = s .. <span class="string">'['</span>..k..<span class="string">'] = '</span> .. SPECTRE.FileIO.persistence.dump(v) .. <span class="string">','</span>
      <span class="keyword">end</span>
      <span class="keyword">return</span> s .. <span class="string">'} '</span>
    <span class="keyword">else</span>
      <span class="keyword">return</span> <span class="global">tostring</span>(o)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="comment">---Store table output to file.
</span>  <span class="comment">--
</span>  <span class="comment">--@param path : filepath
</span>  <a id="126"></a><span class="comment">--@param ... : data
</span>  <span class="keyword">function</span> SPECTRE.FileIO.persistence.store (path, ...)
    <span class="keyword">local</span> file, e = <span class="global">io</span>.open(path, <span class="string">"w"</span>);
    <span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">then</span>
      <span class="keyword">return</span> <span class="global">error</span>(e);
    <span class="keyword">end</span>
    <span class="keyword">local</span> n = <span class="global">select</span>(<span class="string">"#"</span>, ...);
    <span class="comment">-- Count references
</span>    <span class="keyword">local</span> objRefCount = {}; <span class="comment">-- Stores reference that will be exported
</span>    <span class="keyword">for</span> i = <span class="number">1</span>, n <span class="keyword">do</span>
      refCount(objRefCount, (<span class="global">select</span>(i,...)));
    <span class="keyword">end</span>;
    <span class="comment">-- Export Objects with more than one ref and assign name
</span>    <span class="comment">-- First, create empty tables for each
</span>    <span class="keyword">local</span> objRefNames = {};
    <span class="keyword">local</span> objRefIdx = <span class="number">0</span>;
    file:write(<span class="string">"-- Persistent Data\n"</span>);
    file:write(<span class="string">"local multiRefObjects = {\n"</span>);
    <span class="keyword">for</span> obj, count <span class="keyword">in</span> <span class="global">pairs</span>(objRefCount) <span class="keyword">do</span>
      <span class="keyword">if</span> count &gt; <span class="number">1</span> <span class="keyword">then</span>
        objRefIdx = objRefIdx + <span class="number">1</span>;
        objRefNames[obj] = objRefIdx;
        file:write(<span class="string">"{};"</span>); <span class="comment">-- table objRefIdx
</span>      <span class="keyword">end</span>;
    <span class="keyword">end</span>;
    file:write(<span class="string">"\n} -- multiRefObjects\n"</span>);
    <span class="comment">-- Then fill them (this requires all empty multiRefObjects to exist)
</span>    <span class="keyword">for</span> obj, idx <span class="keyword">in</span> <span class="global">pairs</span>(objRefNames) <span class="keyword">do</span>
      <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="global">pairs</span>(obj) <span class="keyword">do</span>
        file:write(<span class="string">"multiRefObjects["</span>..idx..<span class="string">"]["</span>);
        write(file, k, <span class="number">0</span>, objRefNames);
        file:write(<span class="string">"] = "</span>);
        write(file, v, <span class="number">0</span>, objRefNames);
        file:write(<span class="string">";\n"</span>);
      <span class="keyword">end</span>;
    <span class="keyword">end</span>;
    <span class="comment">-- Create the remaining objects
</span>    <span class="keyword">for</span> i = <span class="number">1</span>, n <span class="keyword">do</span>
      file:write(<span class="string">"local "</span>..<span class="string">"obj"</span>..i..<span class="string">" = "</span>);
      write(file, (<span class="global">select</span>(i,...)), <span class="number">0</span>, objRefNames);
      file:write(<span class="string">"\n"</span>);
    <span class="keyword">end</span>
    <span class="comment">-- Return them
</span>    <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">then</span>
      file:write(<span class="string">"return obj1"</span>);
      <span class="keyword">for</span> i = <span class="number">2</span>, n <span class="keyword">do</span>
        file:write(<span class="string">" ,obj"</span>..i);
      <span class="keyword">end</span>;
      file:write(<span class="string">"\n"</span>);
    <span class="keyword">else</span>
      file:write(<span class="string">"return\n"</span>);
    <span class="keyword">end</span>;
    <span class="keyword">if</span> <span class="global">type</span>(path) == <span class="string">"string"</span> <span class="keyword">then</span>
      file:close();
    <span class="keyword">end</span>;
  <span class="keyword">end</span>;
  <span class="comment">---Load table data from file to table.
</span>  <a id="183"></a><span class="comment">--@param path : filepath
</span>  <span class="keyword">function</span> SPECTRE.FileIO.persistence.<span class="global">load</span> (path)
    <span class="keyword">local</span> f, e;
    <span class="keyword">if</span> <span class="global">type</span>(path) == <span class="string">"string"</span> <span class="keyword">then</span>
      f, e = <span class="global">loadfile</span>(path);
    <span class="keyword">else</span>
      f, e = path:read(<span class="string">'*a'</span>)
    <span class="keyword">end</span>
    <span class="keyword">if</span> f <span class="keyword">then</span>
      <span class="keyword">return</span> f();
    <span class="keyword">else</span>
      <span class="keyword">return</span> <span class="keyword">nil</span>, e;
    <span class="keyword">end</span>;
  <span class="keyword">end</span>;

  <span class="comment">-- Private methods
</span>  <span class="comment">-- write thing (dispatcher)
</span>  write = <span class="keyword">function</span> (file, item, level, objRefNames)
    writers[<span class="global">type</span>(item)](file, item, level, objRefNames);
  <span class="keyword">end</span>;

  <span class="comment">-- write indent
</span>  writeIndent = <span class="keyword">function</span> (file, level)
    <span class="keyword">for</span> i = <span class="number">1</span>, level <span class="keyword">do</span>
      file:write(<span class="string">"\t"</span>);
    <span class="keyword">end</span>;
  <span class="keyword">end</span>;

  <span class="comment">-- recursively count references
</span>  refCount = <span class="keyword">function</span> (objRefCount, item)
    <span class="comment">-- only count reference types (tables)
</span>    <span class="keyword">if</span> <span class="global">type</span>(item) == <span class="string">"table"</span> <span class="keyword">then</span>
      <span class="comment">-- Increase ref count
</span>      <span class="keyword">if</span> objRefCount[item] <span class="keyword">then</span>
        objRefCount[item] = objRefCount[item] + <span class="number">1</span>;
      <span class="keyword">else</span>
        objRefCount[item] = <span class="number">1</span>;
        <span class="comment">-- If first encounter, traverse
</span>        <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="global">pairs</span>(item) <span class="keyword">do</span>
          refCount(objRefCount, k);
          refCount(objRefCount, v);
        <span class="keyword">end</span>;
      <span class="keyword">end</span>;
    <span class="keyword">end</span>;
  <span class="keyword">end</span>;

  <span class="comment">-- Format items for the purpose of restoring
</span>  writers = {
    [<span class="string">"nil"</span>] = <span class="keyword">function</span> (file, item)
      file:write(<span class="string">"nil"</span>);
    <span class="keyword">end</span>;
    [<span class="string">"number"</span>] = <span class="keyword">function</span> (file, item)
      file:write(<span class="global">tostring</span>(item));
    <span class="keyword">end</span>;
    [<span class="string">"string"</span>] = <span class="keyword">function</span> (file, item)
      file:write(<span class="global">string</span>.format(<span class="string">"%q"</span>, item));
    <span class="keyword">end</span>;
    [<span class="string">"boolean"</span>] = <span class="keyword">function</span> (file, item)
      <span class="keyword">if</span> item <span class="keyword">then</span>
        file:write(<span class="string">"true"</span>);
      <span class="keyword">else</span>
        file:write(<span class="string">"false"</span>);
      <span class="keyword">end</span>
    <span class="keyword">end</span>;
    [<span class="string">"table"</span>] = <span class="keyword">function</span> (file, item, level, objRefNames)
      <span class="keyword">local</span> refIdx = objRefNames[item];
      <span class="keyword">if</span> refIdx <span class="keyword">then</span>
        <span class="comment">-- Table with multiple references
</span>        file:write(<span class="string">"multiRefObjects["</span>..refIdx..<span class="string">"]"</span>);
      <span class="keyword">else</span>
        <span class="comment">-- Single use table
</span>        file:write(<span class="string">"{\n"</span>);
        <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="global">pairs</span>(item) <span class="keyword">do</span>
          writeIndent(file, level+<span class="number">1</span>);
          file:write(<span class="string">"["</span>);
          write(file, k, level+<span class="number">1</span>, objRefNames);
          file:write(<span class="string">"] = "</span>);
          write(file, v, level+<span class="number">1</span>, objRefNames);
          file:write(<span class="string">";\n"</span>);
        <span class="keyword">end</span>
        writeIndent(file, level);
        file:write(<span class="string">"}"</span>);
      <span class="keyword">end</span>;
    <span class="keyword">end</span>;
    [<span class="string">"function"</span>] = <span class="keyword">function</span> (file, item)
      <span class="comment">-- Does only work for "normal" functions, not those
</span>      <span class="comment">-- with upvalues or c functions
</span>      <span class="keyword">local</span> dInfo = <span class="global">debug</span>.getinfo(item, <span class="string">"uS"</span>);
      <span class="keyword">if</span> dInfo.nups &gt; <span class="number">0</span> <span class="keyword">then</span>
        file:write(<span class="string">"nil --[[functions with upvalue not supported]]"</span>);
      <span class="keyword">elseif</span> dInfo.what ~= <span class="string">"Lua"</span> <span class="keyword">then</span>
        file:write(<span class="string">"nil --[[non-lua function not supported]]"</span>);
      <span class="keyword">else</span>
        <span class="keyword">local</span> r, s = <span class="global">pcall</span>(<span class="global">string</span>.dump,item);
        <span class="keyword">if</span> r <span class="keyword">then</span>
          file:write(<span class="global">string</span>.format(<span class="string">"loadstring(%q)"</span>, s));
        <span class="keyword">else</span>
          file:write(<span class="string">"nil --[[function could not be dumped]]"</span>);
        <span class="keyword">end</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span>;
    [<span class="string">"thread"</span>] = <span class="keyword">function</span> (file, item)
      file:write(<span class="string">"nil --[[thread]]\n"</span>);
    <span class="keyword">end</span>;
    [<span class="string">"userdata"</span>] = <span class="keyword">function</span> (file, item)
      file:write(<span class="string">"nil --[[userdata]]\n"</span>);
    <span class="keyword">end</span>;
  }
<span class="keyword">end</span></pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2023-06-15 13:10:10 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
